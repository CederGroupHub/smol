{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Creating a basic Cluster Expansion"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [],
   "source": [
    "import numpy as np\n",
    "import json\n",
    "from monty.serialization import loadfn\n",
    "from smol.cofe import ClusterSubspace, StructureWrangler, \\\n",
    "    ClusterExpansion, RegressionData"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [],
   "source": [
    "prim = loadfn('../data/lmto_prim.json')"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Loading the DFT data of Li-Mn-Ti-O system"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "630 structures in dataset.\n"
     ]
    }
   ],
   "source": [
    "computed_entries = loadfn('../data/lmto_entries.json')\n",
    "print(f\"{len(computed_entries)} structures in dataset.\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### 0) The prim structure\n",
    "Active sites have fractional compositions. Vacancies are allowed in sites where the composition does not sum to one.\n",
    "\n",
    "0. Is active. The allowed species are: Li+, Ti4+ and Mn3+.\n",
    "1. Is not active. Only O2- is allowed."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Full Formula (Li0.33333333 Ti0.33333333 Mn0.33333333 O1)\n",
      "Reduced Formula: Li0.33333333Ti0.33333333Mn0.33333333O1\n",
      "abc   :   2.969848   2.969848   2.969848\n",
      "angles:  60.000000  60.000000  60.000000\n",
      "Sites (2)\n",
      "  #  SP                                   a    b    c\n",
      "---  ---------------------------------  ---  ---  ---\n",
      "  0  Li+:0.333, Ti4+:0.333, Mn3+:0.333  0    0    0\n",
      "  1  O2-                                0.5  0.5  0.5\n"
     ]
    }
   ],
   "source": [
    "print(prim)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### 1) Create a cluster subspace\n",
    "The `ClusterSubspace` represents all the orbits (groups of equivalent clusters) that will be considered when fitting the cluster expansion. Its main purpose is to compute the **correlations functions** for each included orbit given a structure in the compositional space defined by the prim."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "ClusterBasis: [Prim Composition] Li+0.33333333 Mn3+0.33333333 Ti4+0.33333333 O2-1\n",
      "    [Size] 0\n",
      "      [Orbit] id: 0  orderings: 1\n",
      "    [Size] 1\n",
      "      [Orbit] id: 1  orderings: 2   multiplicity: 1    no. symops: 48  \n",
      "              [Base Cluster] Radius: 0.0   Centroid: [0. 0. 0.]         Points: [[0. 0. 0.]]         \n",
      "    [Size] 2\n",
      "      [Orbit] id: 2  orderings: 3   multiplicity: 6    no. symops: 8   \n",
      "              [Base Cluster] Radius: 1.48  Centroid: [0.  0.  0.5]      Points: [[0. 0. 1.]  [0. 0. 0.]]                  \n",
      "      [Orbit] id: 3  orderings: 3   multiplicity: 3    no. symops: 16  \n",
      "              [Base Cluster] Radius: 2.1   Centroid: [0.5 0.5 0.5]      Points: [[1. 1. 0.]  [0. 0. 1.]]                  \n",
      "      [Orbit] id: 4  orderings: 3   multiplicity: 12   no. symops: 4   \n",
      "              [Base Cluster] Radius: 2.57  Centroid: [0.  0.5 0.5]      Points: [[0. 1. 1.]  [0. 0. 0.]]                  \n",
      "      [Orbit] id: 5  orderings: 3   multiplicity: 6    no. symops: 8   \n",
      "              [Base Cluster] Radius: 2.97  Centroid: [0. 0. 0.]         Points: [[ 0.  0.  1.]  [ 0.  0. -1.]]            \n",
      "      [Orbit] id: 6  orderings: 3   multiplicity: 12   no. symops: 4   \n",
      "              [Base Cluster] Radius: 3.32  Centroid: [0.5 0.  0.5]      Points: [[ 1.  1.  0.]  [ 0. -1.  1.]]            \n",
      "    [Size] 3\n",
      "      [Orbit] id: 7  orderings: 4   multiplicity: 8    no. symops: 6   \n",
      "              [Base Cluster] Radius: 1.48  Centroid: [0.   0.67 0.67]   Points: [[0. 1. 1.]  [0. 1. 0.]  [0. 0. 1.]]                           \n",
      "    [Size] 4\n",
      "      [Orbit] id: 8  orderings: 5   multiplicity: 2    no. symops: 24  \n",
      "              [Base Cluster] Radius: 1.48  Centroid: [0.75 0.75 0.75]   Points: [[1. 1. 1.]  [1. 1. 0.]  [1. 0. 1.]  [0. 1. 1.]]                                    \n",
      "\n"
     ]
    }
   ],
   "source": [
    "subspace = ClusterSubspace.from_cutoffs(prim,\n",
    "                                        cutoffs={2: 7.1, 3: 4, 4: 4},\n",
    "                                        basis='sinusoid',\n",
    "                                        supercell_size='volume')\n",
    "# subspace.add_external_term(EwaldTerm(eta=None))\n",
    "\n",
    "print(subspace) # single site and empty orbits are always included."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "#### 1.1) Computing a correlation vector.\n",
    "A correlation vector for a specific structure (represents the feature vector) used to train and predict target values."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### 2) Create a structure wrangler\n",
    "The `StructureWrangler` is a class that will is used to create and organize the data that will be used to train (and possibly test) the cluster expansion. It makes sure that all the supplied structures appropriately match the prim structure, and obtains the necessary information to correctly normalize target properties (such as energy) necessary for training."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {
    "scrolled": true
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "processed: 0/630\n",
      "processed: 1/630\n",
      "processed: 2/630\n",
      "processed: 3/630\n",
      "processed: 4/630\n",
      "processed: 5/630\n",
      "processed: 6/630\n",
      "processed: 7/630\n",
      "processed: 8/630\n",
      "processed: 9/630\n",
      "processed: 10/630\n",
      "processed: 11/630\n",
      "processed: 12/630\n",
      "processed: 13/630\n",
      "processed: 14/630\n",
      "processed: 15/630\n",
      "processed: 16/630\n",
      "processed: 17/630\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 13 - Li+16 Mn3+16 O2-32{'total_energy': -422.52336463}\n",
      "Index 16 - Mn3+6 Li+6 O2-12{'total_energy': -157.651775}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "processed: 18/630\n",
      "processed: 19/630\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 13 - Li+16 Mn3+16 O2-32{'total_energy': -422.52336463}\n",
      "Index 16 - Mn3+6 Li+6 O2-12{'total_energy': -157.651775}\n",
      "Index 19 - Mn3+6 Li+6 O2-12{'total_energy': -157.61200258}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "processed: 20/630\n",
      "processed: 21/630\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 13 - Li+16 Mn3+16 O2-32{'total_energy': -422.52336463}\n",
      "Index 16 - Mn3+6 Li+6 O2-12{'total_energy': -157.651775}\n",
      "Index 19 - Mn3+6 Li+6 O2-12{'total_energy': -157.61200258}\n",
      "Index 21 - Mn3+6 Li+6 O2-12{'total_energy': -157.86858139999998}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "processed: 22/630\n",
      "processed: 23/630\n",
      "processed: 24/630\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 13 - Li+16 Mn3+16 O2-32{'total_energy': -422.52336463}\n",
      "Index 16 - Mn3+6 Li+6 O2-12{'total_energy': -157.651775}\n",
      "Index 19 - Mn3+6 Li+6 O2-12{'total_energy': -157.61200258}\n",
      "Index 21 - Mn3+6 Li+6 O2-12{'total_energy': -157.86858139999998}\n",
      "Index 23 - Mn3+6 Li+6 O2-12{'total_energy': -157.88582681999998}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "processed: 25/630\n",
      "processed: 26/630\n",
      "processed: 27/630\n",
      "processed: 28/630\n",
      "processed: 29/630\n",
      "processed: 30/630\n",
      "processed: 31/630\n",
      "processed: 32/630\n",
      "processed: 33/630\n",
      "processed: 34/630\n",
      "processed: 35/630\n",
      "processed: 36/630\n",
      "processed: 37/630\n",
      "processed: 38/630\n",
      "processed: 39/630\n",
      "processed: 40/630\n",
      "processed: 41/630\n",
      "processed: 42/630\n",
      "processed: 43/630\n",
      "processed: 44/630\n",
      "processed: 45/630\n",
      "processed: 46/630\n",
      "processed: 47/630\n",
      "processed: 48/630\n",
      "processed: 49/630\n",
      "processed: 50/630\n",
      "processed: 51/630\n",
      "processed: 52/630\n",
      "processed: 53/630\n",
      "processed: 54/630\n",
      "processed: 55/630\n",
      "processed: 56/630\n",
      "processed: 57/630\n",
      "processed: 58/630\n",
      "processed: 59/630\n",
      "processed: 60/630\n",
      "processed: 61/630\n",
      "processed: 62/630\n",
      "processed: 63/630\n",
      "processed: 64/630\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 43 - Li+4 Mn3+4 O2-8{'total_energy': -104.09167402}\n",
      "Index 60 - Mn3+4 Li+4 O2-8{'total_energy': -104.11239212999999}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "processed: 65/630\n",
      "processed: 66/630\n",
      "processed: 67/630\n",
      "processed: 68/630\n",
      "processed: 69/630\n",
      "processed: 70/630\n",
      "processed: 71/630\n",
      "processed: 72/630\n",
      "processed: 73/630\n",
      "processed: 74/630\n",
      "processed: 75/630\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 53 - Mn3+4 Li+4 O2-8{'total_energy': -104.93106644999999}\n",
      "Index 65 - Li+4 Mn3+4 O2-8{'total_energy': -105.05485193}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n",
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 51 - Mn3+4 Li+4 O2-8{'total_energy': -103.79666542}\n",
      "Index 72 - Li+4 Mn3+4 O2-8{'total_energy': -103.27479317999999}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n",
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 61 - Li+4 Mn3+4 O2-8{'total_energy': -104.07207165999999}\n",
      "Index 74 - Li+4 Mn3+4 O2-8{'total_energy': -104.0335375}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "processed: 76/630\n",
      "processed: 77/630\n",
      "processed: 78/630\n",
      "processed: 79/630\n",
      "processed: 80/630\n",
      "processed: 81/630\n",
      "processed: 82/630\n",
      "processed: 83/630\n",
      "processed: 84/630\n",
      "processed: 85/630\n",
      "processed: 86/630\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 66 - Mn3+4 Li+4 O2-8{'total_energy': -104.90261661}\n",
      "Index 81 - Mn3+4 Li+4 O2-8{'total_energy': -104.76946991}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n",
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 76 - Li+4 Mn3+4 O2-8{'total_energy': -104.39110529}\n",
      "Index 83 - Mn3+4 Li+4 O2-8{'total_energy': -104.45155711}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n",
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 85 - Mn3+3 Li+3 O2-6{'total_energy': -78.95606344}\n",
      "Index 86 - Li+3 Mn3+3 O2-6{'total_energy': -79.08766976999999}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n",
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 48 - Mn3+4 Li+4 O2-8{'total_energy': -104.93574505999999}\n",
      "Index 92 - Li+2 Mn3+2 O2-4{'total_energy': -52.29711425}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "processed: 87/630\n",
      "processed: 88/630\n",
      "processed: 89/630\n",
      "processed: 90/630\n",
      "processed: 91/630\n",
      "processed: 92/630\n",
      "processed: 93/630\n",
      "processed: 94/630\n",
      "processed: 95/630\n",
      "processed: 96/630\n",
      "processed: 97/630\n",
      "processed: 98/630\n",
      "processed: 99/630\n",
      "processed: 100/630\n",
      "processed: 101/630\n",
      "processed: 102/630\n",
      "processed: 103/630\n",
      "processed: 104/630\n",
      "processed: 105/630\n",
      "processed: 106/630\n",
      "processed: 107/630\n",
      "processed: 108/630\n",
      "processed: 109/630\n",
      "processed: 110/630\n",
      "processed: 111/630\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 13 - Li+16 Mn3+16 O2-32{'total_energy': -422.52336463}\n",
      "Index 16 - Mn3+6 Li+6 O2-12{'total_energy': -157.651775}\n",
      "Index 19 - Mn3+6 Li+6 O2-12{'total_energy': -157.61200258}\n",
      "Index 21 - Mn3+6 Li+6 O2-12{'total_energy': -157.86858139999998}\n",
      "Index 23 - Mn3+6 Li+6 O2-12{'total_energy': -157.88582681999998}\n",
      "Index 108 - Li+4 Mn3+4 O2-8{'total_energy': -105.63097}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n",
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 85 - Mn3+3 Li+3 O2-6{'total_energy': -78.95606344}\n",
      "Index 86 - Li+3 Mn3+3 O2-6{'total_energy': -79.08766976999999}\n",
      "Index 109 - Li+18 Mn3+18 O2-36{'total_energy': -473.68233}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "processed: 112/630\n",
      "processed: 113/630\n",
      "processed: 114/630\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 85 - Mn3+3 Li+3 O2-6{'total_energy': -78.95606344}\n",
      "Index 86 - Li+3 Mn3+3 O2-6{'total_energy': -79.08766976999999}\n",
      "Index 109 - Li+18 Mn3+18 O2-36{'total_energy': -473.68233}\n",
      "Index 112 - Li+18 Mn3+18 O2-36{'total_energy': -474.24243}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n",
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 85 - Mn3+3 Li+3 O2-6{'total_energy': -78.95606344}\n",
      "Index 86 - Li+3 Mn3+3 O2-6{'total_energy': -79.08766976999999}\n",
      "Index 109 - Li+18 Mn3+18 O2-36{'total_energy': -473.68233}\n",
      "Index 112 - Li+18 Mn3+18 O2-36{'total_energy': -474.24243}\n",
      "Index 115 - Mn3+18 Li+18 O2-36{'total_energy': -473.80347}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "processed: 115/630\n",
      "processed: 116/630\n",
      "processed: 117/630\n",
      "processed: 118/630\n",
      "processed: 119/630\n",
      "processed: 120/630\n",
      "processed: 121/630\n",
      "processed: 122/630\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 85 - Mn3+3 Li+3 O2-6{'total_energy': -78.95606344}\n",
      "Index 86 - Li+3 Mn3+3 O2-6{'total_energy': -79.08766976999999}\n",
      "Index 109 - Li+18 Mn3+18 O2-36{'total_energy': -473.68233}\n",
      "Index 112 - Li+18 Mn3+18 O2-36{'total_energy': -474.24243}\n",
      "Index 115 - Mn3+18 Li+18 O2-36{'total_energy': -473.80347}\n",
      "Index 120 - Mn3+18 Li+18 O2-36{'total_energy': -473.90453}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "processed: 123/630\n",
      "processed: 124/630\n",
      "processed: 125/630\n",
      "processed: 126/630\n",
      "processed: 127/630\n",
      "processed: 128/630\n",
      "processed: 129/630\n",
      "processed: 130/630\n",
      "processed: 131/630\n",
      "processed: 132/630\n",
      "processed: 133/630\n",
      "processed: 134/630\n",
      "processed: 135/630\n",
      "processed: 136/630\n",
      "processed: 137/630\n",
      "processed: 138/630\n",
      "processed: 139/630\n",
      "processed: 140/630\n",
      "processed: 141/630\n",
      "processed: 142/630\n",
      "processed: 143/630\n",
      "processed: 144/630\n",
      "processed: 145/630\n",
      "processed: 146/630\n",
      "processed: 147/630\n",
      "processed: 148/630\n",
      "processed: 149/630\n",
      "processed: 150/630\n",
      "processed: 151/630\n",
      "processed: 152/630\n",
      "processed: 153/630\n",
      "processed: 154/630\n",
      "processed: 155/630\n",
      "processed: 156/630\n",
      "processed: 157/630\n",
      "processed: 158/630\n",
      "processed: 159/630\n",
      "processed: 160/630\n",
      "processed: 161/630\n",
      "processed: 162/630\n",
      "processed: 163/630\n",
      "processed: 164/630\n",
      "processed: 165/630\n",
      "processed: 166/630\n",
      "processed: 167/630\n",
      "processed: 168/630\n",
      "processed: 169/630\n",
      "processed: 170/630\n",
      "processed: 171/630\n",
      "processed: 172/630\n",
      "processed: 173/630\n",
      "processed: 174/630\n",
      "processed: 175/630\n",
      "processed: 176/630\n",
      "processed: 177/630\n",
      "processed: 178/630\n",
      "processed: 179/630\n",
      "processed: 180/630\n",
      "processed: 181/630\n",
      "processed: 182/630\n",
      "processed: 183/630\n",
      "processed: 184/630\n",
      "processed: 185/630\n",
      "processed: 186/630\n",
      "processed: 187/630\n",
      "processed: 188/630\n",
      "processed: 189/630\n",
      "processed: 190/630\n",
      "processed: 191/630\n",
      "processed: 192/630\n",
      "processed: 193/630\n",
      "processed: 194/630\n",
      "processed: 195/630\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 96 - Li+18 Ti4+9 O2-27{'total_energy': -377.54954127}\n",
      "Index 194 - Li+24 Ti4+12 O2-36{'total_energy': -503.42615}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n",
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 195 - Li+24 Ti4+12 O2-36{'total_energy': -504.6361}\n",
      "Index 198 - Li+4 Ti4+2 O2-6{'total_energy': -84.105641}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "processed: 196/630\n",
      "processed: 197/630\n",
      "processed: 198/630\n",
      "processed: 199/630\n",
      "processed: 200/630\n",
      "processed: 201/630\n",
      "processed: 202/630\n",
      "processed: 203/630\n",
      "processed: 204/630\n",
      "processed: 205/630\n",
      "processed: 206/630\n",
      "processed: 207/630\n",
      "processed: 208/630\n",
      "processed: 209/630\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 96 - Li+18 Ti4+9 O2-27{'total_energy': -377.54954127}\n",
      "Index 194 - Li+24 Ti4+12 O2-36{'total_energy': -503.42615}\n",
      "Index 203 - Li+2 Ti4+1 O2-3{'total_energy': -41.919018}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n",
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 96 - Li+18 Ti4+9 O2-27{'total_energy': -377.54954127}\n",
      "Index 194 - Li+24 Ti4+12 O2-36{'total_energy': -503.42615}\n",
      "Index 203 - Li+2 Ti4+1 O2-3{'total_energy': -41.919018}\n",
      "Index 205 - Li+6 Ti4+3 O2-9{'total_energy': -125.91502}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "processed: 210/630\n",
      "processed: 211/630\n",
      "processed: 212/630\n",
      "processed: 213/630\n",
      "processed: 214/630\n",
      "processed: 215/630\n",
      "processed: 216/630\n",
      "processed: 217/630\n",
      "processed: 218/630\n",
      "processed: 219/630\n",
      "processed: 220/630\n",
      "processed: 221/630\n",
      "processed: 222/630\n",
      "processed: 223/630\n",
      "processed: 224/630\n",
      "processed: 225/630\n",
      "processed: 226/630\n",
      "processed: 227/630\n",
      "processed: 228/630\n",
      "processed: 229/630\n",
      "processed: 230/630\n",
      "processed: 231/630\n",
      "processed: 232/630\n",
      "processed: 233/630\n",
      "processed: 234/630\n",
      "processed: 235/630\n",
      "processed: 236/630\n",
      "processed: 237/630\n",
      "processed: 238/630\n",
      "processed: 239/630\n",
      "processed: 240/630\n",
      "processed: 241/630\n",
      "processed: 242/630\n",
      "processed: 243/630\n",
      "processed: 244/630\n",
      "processed: 245/630\n",
      "processed: 246/630\n",
      "processed: 247/630\n",
      "processed: 248/630\n",
      "processed: 249/630\n",
      "processed: 250/630\n",
      "processed: 251/630\n",
      "processed: 252/630\n",
      "processed: 253/630\n",
      "processed: 254/630\n",
      "processed: 255/630\n",
      "processed: 256/630\n",
      "processed: 257/630\n",
      "processed: 258/630\n",
      "processed: 259/630\n",
      "processed: 260/630\n",
      "processed: 261/630\n",
      "processed: 262/630\n",
      "processed: 263/630\n",
      "processed: 264/630\n",
      "processed: 265/630\n",
      "processed: 266/630\n",
      "processed: 267/630\n",
      "processed: 268/630\n",
      "processed: 269/630\n",
      "processed: 270/630\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 266 - Mn3+15 Li+19 Ti4+2 O2-36{'total_energy': -478.20534}\n",
      "Index 267 - Mn3+15 Li+19 Ti4+2 O2-36{'total_energy': -478.14156}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n",
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 268 - Li+19 Mn3+15 Ti4+2 O2-36{'total_energy': -478.19176}\n",
      "Index 269 - Li+19 Ti4+2 Mn3+15 O2-36{'total_energy': -478.54775}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "processed: 271/630\n",
      "processed: 272/630\n",
      "processed: 273/630\n",
      "processed: 274/630\n",
      "processed: 275/630\n",
      "processed: 276/630\n",
      "processed: 277/630\n",
      "processed: 278/630\n",
      "processed: 279/630\n",
      "processed: 280/630\n",
      "processed: 281/630\n",
      "processed: 282/630\n",
      "processed: 283/630\n",
      "processed: 284/630\n",
      "processed: 285/630\n",
      "processed: 286/630\n",
      "processed: 287/630\n",
      "processed: 288/630\n",
      "processed: 289/630\n",
      "processed: 290/630\n",
      "processed: 291/630\n",
      "processed: 292/630\n",
      "processed: 293/630\n",
      "processed: 294/630\n",
      "processed: 295/630\n",
      "processed: 296/630\n",
      "processed: 297/630\n",
      "processed: 298/630\n",
      "processed: 299/630\n",
      "processed: 300/630\n",
      "processed: 301/630\n",
      "processed: 302/630\n",
      "processed: 303/630\n",
      "processed: 304/630\n",
      "processed: 305/630\n",
      "processed: 306/630\n",
      "processed: 307/630\n",
      "processed: 308/630\n",
      "processed: 309/630\n",
      "processed: 310/630\n",
      "processed: 311/630\n",
      "processed: 312/630\n",
      "processed: 313/630\n",
      "processed: 314/630\n",
      "processed: 315/630\n",
      "processed: 316/630\n",
      "processed: 317/630\n",
      "processed: 318/630\n",
      "processed: 319/630\n",
      "processed: 320/630\n",
      "processed: 321/630\n",
      "processed: 322/630\n",
      "processed: 323/630\n",
      "processed: 324/630\n",
      "processed: 325/630\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 96 - Li+18 Ti4+9 O2-27{'total_energy': -377.54954127}\n",
      "Index 194 - Li+24 Ti4+12 O2-36{'total_energy': -503.42615}\n",
      "Index 203 - Li+2 Ti4+1 O2-3{'total_energy': -41.919018}\n",
      "Index 205 - Li+6 Ti4+3 O2-9{'total_energy': -125.91502}\n",
      "Index 323 - Ti4+12 Li+24 O2-36{'total_energy': -503.49035}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "processed: 326/630\n",
      "processed: 327/630\n",
      "processed: 328/630\n",
      "processed: 329/630\n",
      "processed: 330/630\n",
      "processed: 331/630\n",
      "processed: 332/630\n",
      "processed: 333/630\n",
      "processed: 334/630\n",
      "processed: 335/630\n",
      "processed: 336/630\n",
      "processed: 337/630\n",
      "processed: 338/630\n",
      "processed: 339/630\n",
      "processed: 340/630\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 151 - Mn3+18 Li+18 O2-36{'total_energy': -473.16304}\n",
      "Index 340 - Li+18 Mn3+18 O2-36{'total_energy': -473.18089}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n",
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 151 - Mn3+18 Li+18 O2-36{'total_energy': -473.16304}\n",
      "Index 340 - Li+18 Mn3+18 O2-36{'total_energy': -473.18089}\n",
      "Index 341 - Mn3+18 Li+18 O2-36{'total_energy': -473.08014}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "processed: 341/630\n",
      "processed: 342/630\n",
      "processed: 343/630\n",
      "processed: 344/630\n",
      "processed: 345/630\n",
      "processed: 346/630\n",
      "processed: 347/630\n",
      "processed: 348/630\n",
      "processed: 349/630\n",
      "processed: 350/630\n",
      "processed: 351/630\n",
      "processed: 352/630\n",
      "processed: 353/630\n",
      "processed: 354/630\n",
      "processed: 355/630\n",
      "processed: 356/630\n",
      "processed: 357/630\n",
      "processed: 358/630\n",
      "processed: 359/630\n",
      "processed: 360/630\n",
      "processed: 361/630\n",
      "processed: 362/630\n",
      "processed: 363/630\n",
      "processed: 364/630\n",
      "processed: 365/630\n",
      "processed: 366/630\n",
      "processed: 367/630\n",
      "processed: 368/630\n",
      "processed: 369/630\n",
      "processed: 370/630\n",
      "processed: 371/630\n",
      "processed: 372/630\n",
      "processed: 373/630\n",
      "processed: 374/630\n",
      "processed: 375/630\n",
      "processed: 376/630\n",
      "processed: 377/630\n",
      "processed: 378/630\n",
      "processed: 379/630\n",
      "processed: 380/630\n",
      "processed: 381/630\n",
      "processed: 382/630\n",
      "processed: 383/630\n",
      "processed: 384/630\n",
      "processed: 385/630\n",
      "processed: 386/630\n",
      "processed: 387/630\n",
      "processed: 388/630\n",
      "processed: 389/630\n",
      "processed: 390/630\n",
      "processed: 391/630\n",
      "processed: 392/630\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 380 - Mn3+6 Li+22 Ti4+8 O2-36{'total_energy': -493.32099}\n",
      "Index 390 - Li+22 Mn3+6 Ti4+8 O2-36{'total_energy': -493.33222}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n",
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 380 - Mn3+6 Li+22 Ti4+8 O2-36{'total_energy': -493.32099}\n",
      "Index 390 - Li+22 Mn3+6 Ti4+8 O2-36{'total_energy': -493.33222}\n",
      "Index 392 - Li+22 Mn3+6 Ti4+8 O2-36{'total_energy': -493.38501}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n",
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 380 - Mn3+6 Li+22 Ti4+8 O2-36{'total_energy': -493.32099}\n",
      "Index 390 - Li+22 Mn3+6 Ti4+8 O2-36{'total_energy': -493.33222}\n",
      "Index 392 - Li+22 Mn3+6 Ti4+8 O2-36{'total_energy': -493.38501}\n",
      "Index 393 - Li+22 Ti4+8 Mn3+6 O2-36{'total_energy': -493.33785}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "processed: 393/630\n",
      "processed: 394/630\n",
      "processed: 395/630\n",
      "processed: 396/630\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 391 - Li+22 Ti4+8 Mn3+6 O2-36{'total_energy': -493.20104}\n",
      "Index 394 - Li+22 Ti4+8 Mn3+6 O2-36{'total_energy': -493.20144}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "processed: 397/630\n",
      "processed: 398/630\n",
      "processed: 399/630\n",
      "processed: 400/630\n",
      "processed: 401/630\n",
      "processed: 402/630\n",
      "processed: 403/630\n",
      "processed: 404/630\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 395 - Li+23 Mn3+3 Ti4+10 O2-36{'total_energy': -498.74487}\n",
      "Index 402 - Li+23 Ti4+10 Mn3+3 O2-36{'total_energy': -498.74407}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "processed: 405/630\n",
      "processed: 406/630\n",
      "processed: 407/630\n",
      "processed: 408/630\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 395 - Li+23 Mn3+3 Ti4+10 O2-36{'total_energy': -498.74487}\n",
      "Index 402 - Li+23 Ti4+10 Mn3+3 O2-36{'total_energy': -498.74407}\n",
      "Index 408 - Li+23 Ti4+10 Mn3+3 O2-36{'total_energy': -498.73567}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n",
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 395 - Li+23 Mn3+3 Ti4+10 O2-36{'total_energy': -498.74487}\n",
      "Index 402 - Li+23 Ti4+10 Mn3+3 O2-36{'total_energy': -498.74407}\n",
      "Index 408 - Li+23 Ti4+10 Mn3+3 O2-36{'total_energy': -498.73567}\n",
      "Index 410 - Li+23 Ti4+10 Mn3+3 O2-36{'total_energy': -498.74938}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "processed: 409/630\n",
      "processed: 410/630\n",
      "processed: 411/630\n",
      "processed: 412/630\n",
      "processed: 413/630\n",
      "processed: 414/630\n",
      "processed: 415/630\n",
      "processed: 416/630\n",
      "processed: 417/630\n",
      "processed: 418/630\n",
      "processed: 419/630\n",
      "processed: 420/630\n",
      "processed: 421/630\n",
      "processed: 422/630\n",
      "processed: 423/630\n",
      "processed: 424/630\n",
      "processed: 425/630\n",
      "processed: 426/630\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 184 - Mn3+18 Li+18 O2-36{'total_energy': -472.72205}\n",
      "Index 425 - Mn3+18 Li+18 O2-36{'total_energy': -473.1071}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "processed: 427/630\n",
      "processed: 428/630\n",
      "processed: 429/630\n",
      "processed: 430/630\n",
      "processed: 431/630\n",
      "processed: 432/630\n",
      "processed: 433/630\n",
      "processed: 434/630\n",
      "processed: 435/630\n",
      "processed: 436/630\n",
      "processed: 437/630\n",
      "processed: 438/630\n",
      "processed: 439/630\n",
      "processed: 440/630\n",
      "processed: 441/630\n",
      "processed: 442/630\n",
      "processed: 443/630\n",
      "processed: 444/630\n",
      "processed: 445/630\n",
      "processed: 446/630\n",
      "processed: 447/630\n",
      "processed: 448/630\n",
      "processed: 449/630\n",
      "processed: 450/630\n",
      "processed: 451/630\n",
      "processed: 452/630\n",
      "processed: 453/630\n",
      "processed: 454/630\n",
      "processed: 455/630\n",
      "processed: 456/630\n",
      "processed: 457/630\n",
      "processed: 458/630\n",
      "processed: 459/630\n",
      "processed: 460/630\n",
      "processed: 461/630\n",
      "processed: 462/630\n",
      "processed: 463/630\n",
      "processed: 464/630\n",
      "processed: 465/630\n",
      "processed: 466/630\n",
      "processed: 467/630\n",
      "processed: 468/630\n",
      "processed: 469/630\n",
      "processed: 470/630\n",
      "processed: 471/630\n",
      "processed: 472/630\n",
      "processed: 473/630\n",
      "processed: 474/630\n",
      "processed: 475/630\n",
      "processed: 476/630\n",
      "processed: 477/630\n",
      "processed: 478/630\n",
      "processed: 479/630\n",
      "processed: 480/630\n",
      "processed: 481/630\n",
      "processed: 482/630\n",
      "processed: 483/630\n",
      "processed: 484/630\n",
      "processed: 485/630\n",
      "processed: 486/630\n",
      "processed: 487/630\n",
      "processed: 488/630\n",
      "processed: 489/630\n",
      "processed: 490/630\n",
      "processed: 491/630\n",
      "processed: 492/630\n",
      "processed: 493/630\n",
      "processed: 494/630\n",
      "processed: 495/630\n",
      "processed: 496/630\n",
      "processed: 497/630\n",
      "processed: 498/630\n",
      "processed: 499/630\n",
      "processed: 500/630\n",
      "processed: 501/630\n",
      "processed: 502/630\n",
      "processed: 503/630\n",
      "processed: 504/630\n",
      "processed: 505/630\n",
      "processed: 506/630\n",
      "processed: 507/630\n",
      "processed: 508/630\n",
      "processed: 509/630\n",
      "processed: 510/630\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/home/lbluque/Develop/smol/smol/cofe/wrangling/wrangler.py:652: UserWarning: The following structures have duplicated correlation vectors:\n",
      " Index 506 - Li+23 Ti4+10 Mn3+3 O2-36{'total_energy': -498.01167}\n",
      "Index 507 - Li+23 Mn3+3 Ti4+10 O2-36{'total_energy': -497.84187}\n",
      " Consider adding more terms to the clustersubspace or filtering duplicates.\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "processed: 511/630\n",
      "processed: 512/630\n",
      "processed: 513/630\n",
      "processed: 514/630\n",
      "processed: 515/630\n",
      "processed: 516/630\n",
      "processed: 517/630\n",
      "processed: 518/630\n",
      "processed: 519/630\n",
      "processed: 520/630\n",
      "processed: 521/630\n",
      "processed: 522/630\n",
      "processed: 523/630\n",
      "processed: 524/630\n",
      "processed: 525/630\n",
      "processed: 526/630\n",
      "processed: 527/630\n",
      "processed: 528/630\n",
      "processed: 529/630\n",
      "processed: 530/630\n",
      "processed: 531/630\n",
      "processed: 532/630\n",
      "processed: 533/630\n",
      "processed: 534/630\n",
      "processed: 535/630\n",
      "processed: 536/630\n",
      "processed: 537/630\n",
      "processed: 538/630\n",
      "processed: 539/630\n",
      "processed: 540/630\n",
      "processed: 541/630\n",
      "processed: 542/630\n",
      "processed: 543/630\n",
      "processed: 544/630\n",
      "processed: 545/630\n",
      "processed: 546/630\n",
      "processed: 547/630\n",
      "processed: 548/630\n",
      "processed: 549/630\n",
      "processed: 550/630\n",
      "processed: 551/630\n",
      "processed: 552/630\n",
      "processed: 553/630\n",
      "processed: 554/630\n",
      "processed: 555/630\n",
      "processed: 556/630\n",
      "processed: 557/630\n",
      "processed: 558/630\n",
      "processed: 559/630\n",
      "processed: 560/630\n",
      "processed: 561/630\n",
      "processed: 562/630\n",
      "processed: 563/630\n",
      "processed: 564/630\n",
      "processed: 565/630\n",
      "processed: 566/630\n",
      "processed: 567/630\n",
      "processed: 568/630\n",
      "processed: 569/630\n",
      "processed: 570/630\n",
      "processed: 571/630\n",
      "processed: 572/630\n",
      "processed: 573/630\n",
      "processed: 574/630\n",
      "processed: 575/630\n",
      "processed: 576/630\n",
      "processed: 577/630\n",
      "processed: 578/630\n",
      "processed: 579/630\n",
      "processed: 580/630\n",
      "processed: 581/630\n",
      "processed: 582/630\n",
      "processed: 583/630\n",
      "processed: 584/630\n",
      "processed: 585/630\n",
      "processed: 586/630\n",
      "processed: 587/630\n",
      "processed: 588/630\n",
      "processed: 589/630\n",
      "processed: 590/630\n",
      "processed: 591/630\n",
      "processed: 592/630\n",
      "processed: 593/630\n",
      "processed: 594/630\n",
      "processed: 595/630\n",
      "processed: 596/630\n",
      "processed: 597/630\n",
      "processed: 598/630\n",
      "processed: 599/630\n",
      "processed: 600/630\n",
      "processed: 601/630\n",
      "processed: 602/630\n",
      "processed: 603/630\n",
      "processed: 604/630\n",
      "processed: 605/630\n",
      "processed: 606/630\n",
      "processed: 607/630\n",
      "processed: 608/630\n",
      "processed: 609/630\n",
      "processed: 610/630\n",
      "processed: 611/630\n",
      "processed: 612/630\n",
      "processed: 613/630\n",
      "processed: 614/630\n",
      "processed: 615/630\n",
      "processed: 616/630\n",
      "processed: 617/630\n",
      "processed: 618/630\n",
      "processed: 619/630\n",
      "processed: 620/630\n",
      "processed: 621/630\n",
      "processed: 622/630\n",
      "processed: 623/630\n",
      "processed: 624/630\n",
      "processed: 625/630\n",
      "processed: 626/630\n",
      "processed: 627/630\n",
      "processed: 628/630\n",
      "processed: 629/630\n",
      "\n",
      "Total structures that match 630/630\n"
     ]
    }
   ],
   "source": [
    "wrangler = StructureWrangler(subspace)\n",
    "\n",
    "# you can add any number of properties and name them\n",
    "# whatever you want. You should use something descriptive.\n",
    "# In this case we'll call it 'total_energy'.\n",
    "for i, entry in enumerate(computed_entries):\n",
    "    print(\"processed: {}/{}\".format(i, len(computed_entries)))\n",
    "    wrangler.add_data(entry.structure,\n",
    "                      properties={'total_energy': entry.energy},\n",
    "                      verbose=True)\n",
    "# The verbose flag will print structures that fail to match.\n",
    "\n",
    "print(f'\\nTotal structures that match {wrangler.num_structures}/{len(computed_entries)}')"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 3) Training\n",
    "\n",
    "Training a cluster expansion is one of the most critical steps. This is how you get **effective cluster interactions (ECI's)**. To do so you need an estimator class that implements some form of regression model. In this case we will use simple least squares regression using the `LinearRegression` estimator from `scikit-learn`.\n",
    "\n",
    "In `smol` the coefficients from the fit are not exactly the ECI's but the ECI times the multiplicity of their orbit."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {},
   "outputs": [],
   "source": [
    "from sklearn.linear_model import LinearRegression\n",
    "# Set fit_intercept to False because we already do this using\n",
    "# the empty cluster.\n",
    "estimator = LinearRegression(fit_intercept=False)\n",
    "estimator.fit(wrangler.feature_matrix,\n",
    "              wrangler.get_property_vector('total_energy'))\n",
    "coefs = estimator.coef_"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "#### 3.1) Check the quality of the fit"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "RMSE 0.013719719976843134 eV/prim\n",
      "MAX 0.10229881737488533 eV/prim\n"
     ]
    }
   ],
   "source": [
    "from sklearn.metrics import mean_squared_error, max_error\n",
    "\n",
    "train_predictions = np.dot(wrangler.feature_matrix, coefs)\n",
    "\n",
    "rmse = mean_squared_error(wrangler.get_property_vector('total_energy'),\n",
    "                          train_predictions, squared=False)\n",
    "maxer = max_error(wrangler.get_property_vector('total_energy'),\n",
    "                  train_predictions)\n",
    "\n",
    "print(f'RMSE {rmse} eV/prim')\n",
    "print(f'MAX {maxer} eV/prim')"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### 4) Create a cluster expansion"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "The predicted energy for a structure with composition Mn3+9 Li+21 Ti4+6 O2-36 is -13.550963091022656 eV/prim.\n",
      "\n",
      "The fitted coefficients are:\n",
      "[-1.41649677e+11 -3.54124192e+11  1.22672219e+11  7.93385756e-01\n",
      " -5.30298691e-01  1.55481332e-01  4.38792541e-01 -2.09197422e-01\n",
      "  5.72421679e-02  1.99144459e-01  1.62832331e-01 -1.10884296e-01\n",
      "  1.44084032e-01  6.09243067e-02 -3.38844332e-02  2.38991409e-01\n",
      " -1.30564341e-01 -1.23614042e-02 -2.50345094e-01 -1.03712695e-01\n",
      "  4.50283643e-01  7.79379756e-02 -6.63553619e-02 -1.05656329e-01\n",
      "  2.81985642e-01  1.38585686e-01 -1.30902417e-01]\n",
      "\n",
      "The effective cluster interactions are:\n",
      "[-1.41649677e+11 -3.54124192e+11  1.22672219e+11  1.32230959e-01\n",
      " -4.41915576e-02  2.59135553e-02  1.46264180e-01 -3.48662371e-02\n",
      "  1.90807226e-02  1.65953715e-02  6.78468044e-03 -9.24035801e-03\n",
      "  2.40140053e-02  5.07702555e-03 -5.64740553e-03  1.99159507e-02\n",
      " -5.44018086e-03 -1.03011701e-03 -3.12931368e-02 -4.32136227e-03\n",
      "  1.87618185e-02  9.74224694e-03 -3.31776809e-02 -1.32070411e-02\n",
      "  2.34988035e-02  1.73232107e-02 -6.54512087e-02]\n",
      "\n",
      "ClusterExpansion:\n",
      "    Prim Composition: Li+0.33333333 Mn3+0.33333333 Ti4+0.33333333 O2-1\n",
      "Num corr functions: 27\n",
      "    [Orbit]  id: 0  \n",
      "        bit       eci\n",
      "        [X]       -1.42e+11\n",
      "    [Orbit]  id: 1   size: 1   radius: 0.0 \n",
      "        id    bit       eci     feature avg  feature std  eci*std\n",
      "        1     [0]       -354124192092.776-0.337       0.089        -31535657800.435\n",
      "        2     [1]       122672218580.1490.182        0.257        31535657800.783\n",
      "    [Orbit]  id: 3   size: 2   radius: 2.97\n",
      "        id    bit       eci     feature avg  feature std  eci*std\n",
      "        3     [0 0]     0.793   0.049        0.080        0.064\n",
      "        4     [0 1]     -0.530  -0.050       0.115        -0.061\n",
      "        5     [1 1]     0.155   0.085        0.069        0.011\n",
      "    [Orbit]  id: 6   size: 2   radius: 4.2 \n",
      "        id    bit       eci     feature avg  feature std  eci*std\n",
      "        6     [0 0]     0.439   0.089        0.108        0.047\n",
      "        7     [0 1]     -0.209  -0.029       0.112        -0.023\n",
      "        8     [1 1]     0.057   0.094        0.086        0.005\n",
      "    [Orbit]  id: 9   size: 2   radius: 5.14\n",
      "        id    bit       eci     feature avg  feature std  eci*std\n",
      "        9     [0 0]     0.199   0.163        0.083        0.016\n",
      "        10    [0 1]     0.163   -0.035       0.074        0.012\n",
      "        11    [1 1]     -0.111  0.099        0.089        -0.010\n",
      "    [Orbit]  id: 12  size: 2   radius: 5.94\n",
      "        id    bit       eci     feature avg  feature std  eci*std\n",
      "        12    [0 0]     0.144   0.117        0.131        0.019\n",
      "        13    [0 1]     0.061   -0.048       0.094        0.006\n",
      "        14    [1 1]     -0.034  0.097        0.080        -0.003\n",
      "    [Orbit]  id: 15  size: 2   radius: 6.64\n",
      "        id    bit       eci     feature avg  feature std  eci*std\n",
      "        15    [0 0]     0.239   0.105        0.081        0.019\n",
      "        16    [0 1]     -0.131  -0.045       0.093        -0.012\n",
      "        17    [1 1]     -0.012  0.093        0.078        -0.001\n",
      "    [Orbit]  id: 18  size: 3   radius: 2.97\n",
      "        id    bit       eci     feature avg  feature std  eci*std\n",
      "        18    [0 0 0]   -0.250  0.031        0.055        -0.014\n",
      "        19    [1 0 0]   -0.104  -0.009       0.039        -0.004\n",
      "        20    [1 0 1]   0.450   -0.043       0.035        0.016\n",
      "        21    [1 1 1]   0.078   0.021        0.028        0.002\n",
      "    [Orbit]  id: 22  size: 4   radius: 2.97\n",
      "        id    bit       eci     feature avg  feature std  eci*std\n",
      "        22    [0 0 0 0] -0.066  -0.011       0.085        -0.006\n",
      "        23    [0 1 0 0] -0.106  0.026        0.048        -0.005\n",
      "        24    [0 1 0 1] 0.282   0.017        0.027        0.008\n",
      "        25    [1 1 0 1] 0.139   -0.012       0.018        0.003\n",
      "        26    [1 1 1 1] -0.131  0.005        0.012        -0.002\n",
      "\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/tmp/ipykernel_296408/2662299786.py:9: VisibleDeprecationWarning: Creating an ndarray from ragged nested sequences (which is a list-or-tuple of lists-or-tuples-or ndarrays with different lengths or shapes) is deprecated. If you meant to do this, you must specify 'dtype=object' when creating the ndarray.\n",
      "  structure = np.random.choice(wrangler.structures)\n"
     ]
    }
   ],
   "source": [
    "# save details of the regression used to fit\n",
    "reg_data = RegressionData.from_sklearn(\n",
    "    estimator, feature_matrix=wrangler.feature_matrix,\n",
    "    property_vector=wrangler.get_property_vector('total_energy'))\n",
    "\n",
    "expansion = ClusterExpansion(\n",
    "    subspace, coefficients=coefs, regression_data=reg_data)\n",
    "\n",
    "structure = np.random.choice(wrangler.structures)\n",
    "prediction = expansion.predict(structure, normalize=True)\n",
    "\n",
    "print(f'The predicted energy for a structure with composition '\n",
    "      f'{structure.composition} is {prediction} eV/prim.\\n')\n",
    "print(f'The fitted coefficients are:\\n{expansion.coefs}\\n')\n",
    "print(f'The effective cluster interactions are:\\n{expansion.eci}\\n')\n",
    "print(expansion)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### 5) Saving your work\n",
    "All core classes in `smol` are `MSONables` and so can be saved using their `as_dict` methods or better yet with `monty.serialization.dumpfn`.\n",
    "\n",
    "Currently there is also a convenience function in `smol` that will nicely save all of your work for you in a standardized way. Work saved with the `save_work` function is saved as a dictionary with standardized names for the classes. Since a work flow should only contain 1 of each core classes the function will complain if you give it two of the same class (i.e. two wranglers)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "metadata": {},
   "outputs": [],
   "source": [
    "from smol.io import load_work, save_work\n",
    "\n",
    "file_path = '../data/lmto_sinusoid.mson'\n",
    "# we can save the subspace as well, but since both the wrangler\n",
    "# and the expansion have it, there is no need to do so.\n",
    "save_work(file_path, wrangler, expansion)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "#### 5.1) Loading previously saved work"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "StructureWrangler: <class 'smol.cofe.wrangling.wrangler.StructureWrangler'>\n",
      "\n",
      "ClusterExpansion: <class 'smol.cofe.expansion.ClusterExpansion'>\n",
      "\n"
     ]
    }
   ],
   "source": [
    "from smol.io import load_work, save_work\n",
    "\n",
    "work = load_work(file_path)\n",
    "for name, obj in work.items():\n",
    "    print(f'{name}: {type(obj)}\\n')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "matx_dev",
   "language": "python",
   "name": "matx_dev"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.9.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
