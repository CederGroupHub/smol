<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>&lt;no title&gt; &#8212; smol 1.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/_static/default.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          smol</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../examples.html">Examples</a></li>
                <li><a href="../api.html">API</a></li>
                <li><a href="https://github.com/CederGroupHub/smol">GitHub</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul class="simple">
</ul>
</ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <dl>
<dt>{</dt><dd><dl>
<dt>“cells”: [</dt><dd><dl>
<dt>{</dt><dd><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“# Training Data Preparation”</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 1,
“metadata”: {},
“outputs”: [</p>
<blockquote>
<div><dl>
<dt>{</dt><dd><p>“name”: “stderr”,
“output_type”: “stream”,
“text”: [</p>
<blockquote>
<div><p>“/home/lbluque/Develop/pymatgen/pymatgen/ext/matproj.py:454: DeprecationWarning: __init__ is deprecatedn”,
“MaterialsProjectCompatibility will be updated with new correction classes as well as new values of corrections and uncertainties in 2020n”,
”  def get_pourbaix_entries(self, chemsys, solid_compat=MaterialsProjectCompatibility()):n”</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>],
“source”: [</p>
<blockquote>
<div><p>“import numpy as npn”,
“import jsonn”,
“from monty.serialization import loadfnn”,
“from pymatgen.core.structure import Structuren”,
“from smol.cofe import ClusterSubspace, StructureWranglern”,
“from smol.cofe.configspace import get_specie”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“### 1) Preparing a <cite>StructureWrangler</cite>n”,
“Training structures and target data are handled by the <cite>StructureWrangler</cite> class. The class obtains the features and corresponding feature matrix based on the underlying <cite>ClusterSubspace</cite> provided.n”,
“n”,
“In the most simply settings we just use the feature matrix our supplied total energy from DFT to fit a cluster expansion. But it many cases we may want to improve our fit quality or reduce the model complexity by modifying the target property (i.e. using a reference energy or the energy of mixing) and/or by weighing structures based on some importance metric (i.e. by energy above hull). Using the <cite>StructureWrangler</cite> we can create this modified fitting data.”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 2,
“metadata”: {},
“outputs”: [</p>
<blockquote>
<div><dl>
<dt>{</dt><dd><p>“name”: “stdout”,
“output_type”: “stream”,
“text”: [</p>
<blockquote>
<div><p>“n”,
“Total structures that match 27/31n”</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>],
“source”: [</p>
<blockquote>
<div><p>“# Load the raw datan”,
“# load the prim structuren”,
“lno_prim = loadfn(‘data/lno_prim.json’)n”,
”    n”,
“# load the fitting datan”,
“with open(‘data/lno_fitting_data.json’, ‘r’) as f:n”,
”    lno_data = [(Structure.from_dict(x[‘s’]), x[‘toten’]) for x in json.load(f)]n”,
“n”,
”    n”,
“# create a cluster subspacen”,
“subspace = ClusterSubspace.from_cutoffs(lno_prim,n”,
”                                        cutoffs={2: 5, 3: 4.1},n”,
”                                        basis=’sinusoid’,n”,
”                                        supercell_size=’O2-‘)n”,
“n”,
“# create the structre wranglern”,
“wrangler = StructureWrangler(subspace)n”,
“n”,
“# add the raw datan”,
“for structure, tot_energy in lno_data:n”,
”    wrangler.add_data(structure,n”,
”                      properties={‘total_energy’: tot_energy})n”,
“n”,
“print(f’\nTotal structures that match {wrangler.num_structures}/{len(lno_data)}’)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“### 2) Modifying and adding new target propertiesn”,
“n”,
“Now that we have access to the structures that match to our cluster subspace, and access to the raw and normalized target properties, we can easily create new modifiend target properties to fit to.n”,
“n”,
“For a simple example say we simply want to set the minimum energy in our data as a new reference point.”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 3,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“# obtain the minimum energy. Calling the get_property_vectorn”,
“# will by default give you the property normalized per prim n”,
“# (you should always used consistently normalized data when fitting)n”,
“min_energy = min(wrangler.get_property_vector(‘total_energy’))n”,
“n”,
“# simply create a new re-reference energyn”,
“reref_energy_vect = wrangler.get_property_vector(‘total_energy’) - min_energyn”,
“n”,
“# add it as a new property to the wranglern”,
“# in this case since the reref energy is a normalizedn”,
“# quantity we need to explicitly tell the wranglern”,
“wrangler.add_properties(‘rereferenced_energy’,n”,
”                        reref_energy_vect,n”,
”                        normalized=False)n”,
“n”,
“# Now we have to properties in the wrangler that we cann”,
“# use to fit a cluster expansion, the total energyn”,
“# and the rereference energy”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“### 2.1) Another example of modifying target propertiesn”,
“n”,
“We can do more complex modifications of the target data. For example a very common target property to fit a cluster expansion is the mixing energy. n”,
“n”,
“For the current LNO dataset we don’t have a fully delithiated structure, but for the sake of illustration lets assume that we use Ni2O3. (Plus in this dataset mixing energy is not very informative since it is almost linear in concentration.)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 4,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“e_Ni2O3 = -12.48n”,
“n”,
“# we can obtain the fully lithiated structure in the dataset by searchingn”,
“# through the occupancy strings.n”,
“ind = [i for i, s in enumerate(wrangler.occupancy_strings) if ‘Vacancy’ not in s]n”,
“e_LiNiO2 = wrangler.get_property_vector(‘total_energy’)[ind[0]]n”,
“n”,
“# Now we can calculate the Li/Vacancy mixing energy for the structures in our datasetn”,
“# There are many ways you can obtain concentrations/compositions, you can also usen”,
“# the stored pymatgen structures to do so, here I use the occupancy strings storedn”,
“# in the wrangler.n”,
“mixing_energy = []n”,
“concentration = []n”,
“for energy, occu in zip(wrangler.get_property_vector(‘total_energy’),n”,
”                        wrangler.occupancy_strings):n”,
”    n_Li = sum(sp == get_specie(‘Li+’) for sp in occu)n”,
”    n_vac = sum(sp == get_specie(‘Vacancy’) for sp in occu)n”,
”    c_Li = n_Li/(n_Li + n_vac)n”,
”    mix_en = energy - c_Li*e_LiNiO2 - (1 - c_Li)*e_Ni2O3n”,
”    concentration.append(c_Li)n”,
”    mixing_energy.append(mix_en)n”,
“n”,
“# add the properties to the wranglern”,
“wrangler.add_properties(‘mixing_energy’,n”,
”                        mixing_energy,n”,
”                        normalized=True)n”,
“wrangler.add_properties(‘li_concentration’,n”,
”                        concentration,n”,
”                        normalized=True)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“### 3) Obtaining and adding weightsn”,
“n”,
“Using the structure wrangler it is also very easy to obtain fitting weights based many things such as composition, total energy or energy above hull. Currently the code has the previously available functions to obtaine weights by energy above hull or by energy above composition.”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 5,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“from smol.cofe import weights_energy_above_hull, weights_energy_above_compositionn”,
“n”,
“above_compostion = weights_energy_above_composition(wrangler.structures,n”,
”                                                    wrangler.get_property_vector(‘total_energy’, normalize=False),n”,
”                                                    temperature=1000)n”,
“n”,
“above_hull = weights_energy_above_hull(wrangler.structures,n”,
”                                       wrangler.get_property_vector(‘total_energy’, normalize=False),n”,
”                                       cs_structure=wrangler.cluster_subspace.structure,n”,
”                                       temperature=1000)n”,
“n”,
“# add them to the wranglern”,
“wrangler.add_weights(‘e_above_comp’, above_compostion)n”,
“wrangler.add_weights(‘e_above_hull’, above_hull)n”,
“n”,
“# to use weights in a fit you would simply pass them ton”,
“# the corresponding argument or keyword argument ofn”,
“# the fitting function you are using.n”,
“# For example if you are using a regression class fromn”,
“# scikit-learn, the signature is:n”,
“# estimator.fit(wragler.feature_matrix,n”,
“#                wrangler.get_property_vectory(‘total_energy’),n”,
“#                sample_weight=wrangler.get_weights(‘e_above_hull’))”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“### 4) Filtering structuresn”,
“The <cite>StructureWrangler</cite> class can also be used to filter structures to use for a fit based on some criteria.n”,
“n”,
“Currently only a filter by maximum ewald energy is implemented as part of the class.n”,
“n”,
“Going forward more filtering options can be implemented as people write and use different methods of filtering functions.”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 6,
“metadata”: {},
“outputs”: [</p>
<blockquote>
<div><dl>
<dt>{</dt><dd><p>“name”: “stderr”,
“output_type”: “stream”,
“text”: [</p>
<blockquote>
<div><p>“&lt;ipython-input-6-aea799c1d123&gt;:6: DeprecationWarning: the filter_by_ewald method is going to be deprecated.n”,
“The functionality will still be available but with a different interfacen”,
”  wrangler.filter_by_ewald(max_ewald=2)n”</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>},
{</p>
<blockquote>
<div><p>“name”: “stdout”,
“output_type”: “stream”,
“text”: [</p>
<blockquote>
<div><p>“Kept 26/27 structures with Ewald energies &lt; 2 eV/prim.n”,
“The filters are saved as [{‘Ewald’: {‘max_ewald’: 2, ‘nstructs_removed’: 1, ‘nstructs_total’: 27}}]n”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>],
“source”: [</p>
<blockquote>
<div><p>“# filter by maximum ewald energyn”,
“# all structures with ewald energy above the cutoffn”,
“# will be removedn”,
“n”,
“n_structs_before = wrangler.num_structuresn”,
“wrangler.filter_by_ewald(max_ewald=2)n”,
“n”,
“print(f’Kept {wrangler.num_structures}/{n_structs_before} structures with Ewald energies &lt; 2 eV/prim.’)n”,
“print(f&quot;The filters are saved as {wrangler.metadata[‘applied_filters’]}&quot;)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: []</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>],
“metadata”: {</p>
<blockquote>
<div><dl class="simple">
<dt>“kernelspec”: {</dt><dd><p>“display_name”: “matx_dev”,
“language”: “python”,
“name”: “matx_dev”</p>
</dd>
</dl>
<p>},
“language_info”: {</p>
<blockquote>
<div><dl class="simple">
<dt>“codemirror_mode”: {</dt><dd><p>“name”: “ipython”,
“version”: 3</p>
</dd>
</dl>
<p>},
“file_extension”: “.py”,
“mimetype”: “text/x-python”,
“name”: “python”,
“nbconvert_exporter”: “python”,
“pygments_lexer”: “ipython3”,
“version”: “3.8.5”</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>},
“nbformat”: 4,
“nbformat_minor”: 4</p>
</dd>
</dl>
<p>}</p>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2020, Ceder Group.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.1.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>