<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>&lt;no title&gt; &#8212; smol 1.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/_static/default.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          smol</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../examples.html">Examples</a></li>
                <li><a href="../api.html">API</a></li>
                <li><a href="https://github.com/CederGroupHub/smol">GitHub</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul class="simple">
</ul>
</ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <dl>
<dt>{</dt><dd><dl>
<dt>“cells”: [</dt><dd><dl>
<dt>{</dt><dd><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“# Adding Structures in Parallel”</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 1,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“import numpy as npn”,
“import jsonn”,
“from monty.serialization import loadfnn”,
“from pymatgen.core.structure import Structuren”,
“from smol.cofe import ClusterSubspace, StructureWrangler”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“### 1) Preparing a <cite>StructureWrangler</cite>n”,
“When adding large structures or structures that underwent a considerable amount of relaxation (compared to the primitive structure) to a <cite>StructureWrangler</cite>, it can be time consuming to appropriately match the structures to compute the correlations vector for the feature matrix. In this case it can be very helpful (and easy!) to add structures in a dataset in parallel.n”,
“n”,
“First, we’ll prepare the cluster subspace and structure wrangler as before.”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 2,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“# Load the raw datan”,
“n”,
“# load the prim structuren”,
“lmof_prim = loadfn(‘data/lmof_prim.json’)n”,
”    n”,
“# load the fitting datan”,
“lmof_data =loadfn(‘data/lmof_fitting_data.json’)n”,
”    n”,
“# create a cluster subspacen”,
“subspace = ClusterSubspace.from_cutoffs(lmof_prim,n”,
”                                        cutoffs={2: 7, 3: 5},n”,
”                                        basis=’sinusoid’,n”,
”                                        supercell_size=(‘O2-’, ‘F-‘),n”,
”                                        ltol = 0.15, stol = 0.2,n”,
”                                        angle_tol = 15)n”,
“n”,
“# create the structre wranglern”,
“wrangler = StructureWrangler(subspace)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“### 2) Add structures in paralleln”,
“Since adding structures is an embarassingly parallel operation,n”,
“all we need to do is run a parallel loop. There are a few ways ton”,
“do this in python. Here we will use the <cite>joblib</cite> library. But using <cite>multiprocessing</cite> n”,
“would be very similar.”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 4,
“metadata”: {},
“outputs”: [</p>
<blockquote>
<div><dl>
<dt>{</dt><dd><p>“name”: “stdout”,
“output_type”: “stream”,
“text”: [</p>
<blockquote>
<div><p>“This computers has 8 cpus.n”</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>},
{</p>
<blockquote>
<div><p>“name”: “stderr”,
“output_type”: “stream”,
“text”: [</p>
<blockquote>
<div><p>“[Parallel(n_jobs=8)]: Using backend LokyBackend with 8 concurrent workers.n”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“name”: “stdout”,
“output_type”: “stream”,
“text”: [</p>
<blockquote>
<div><p>“Parallel finished in 25.01846957206726 seconds.n”,
“Matched 17/26n”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“name”: “stderr”,
“output_type”: “stream”,
“text”: [</p>
<blockquote>
<div><p>“[Parallel(n_jobs=8)]: Done  26 out of  26 | elapsed:   25.0s finishedn”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>],
“source”: [</p>
<blockquote>
<div><p>“from time import timen”,
“from joblib import Parallel, delayed, cpu_countn”,
“n”,
“print(f’This computers has {cpu_count()} cpus.’)n”,
“n”,
“nprocs = cpu_count()  # setting this to -1 also uses all cpusn”,
“n”,
“# setting a batch size usually improves speedn”,
“batch_size = ‘auto’ #len(lmof_data)//nprocsn”,
“n”,
“start = time()n”,
“n”,
“# we need to add the data a bit differently to avoid having to usen”,
“# shared memory between processesn”,
“with Parallel(n_jobs=nprocs, batch_size=batch_size, verbose=True) as parallel: n”,
”    items = parallel(delayed(wrangler.process_structure)(struct, {‘energy’: energy})n”,
”                                                         for struct, energy in lmof_data)n”,
“n”,
“# unpack the items and remove Nones from structure that failed to matchn”,
“data_items = [item for item in items if item is not None]n”,
“wrangler.append_data_items(data_items)n”,
“n”,
“print(f’Parallel finished in {time()-start} seconds.’)n”,
“print(f’Matched {wrangler.num_structures}/{len(lmof_data)} structures.’)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“1.1) Compare with serial code”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 5,
“metadata”: {},
“outputs”: [</p>
<blockquote>
<div><dl>
<dt>{</dt><dd><p>“name”: “stdout”,
“output_type”: “stream”,
“text”: [</p>
<blockquote>
<div><p>“Unable to match Li+6 Mn3+6 Mn4+3 O2-18 with properties {‘energy’: -363.8585} to supercell_structure. Throwing out.n”,
” Error Message: Mapping could not be found from structure.n”,
“Unable to match Mn3+32 O2-48 with properties {‘energy’: -1057.1584} to supercell_structure. Throwing out.n”,
” Error Message: Supercell could not be found from structuren”,
“Unable to match Li+8 Mn2+4 Mn4+12 O2-32 with properties {‘energy’: -636.38575} to supercell_structure. Throwing out.n”,
” Error Message: Mapping could not be found from structure.n”,
“Unable to match Li+9 Mn3+5 Mn4+2 O2-16 with properties {‘energy’: -321.99251} to supercell_structure. Throwing out.n”,
” Error Message: Mapping could not be found from structure.n”,
“Unable to match Li+7 Mn3+6 Mn4+4 Mn2+1 O2-19 F-5 with properties {‘energy’: -453.85747} to supercell_structure. Throwing out.n”,
” Error Message: Mapping could not be found from structure.n”,
“Unable to match Li+7 Mn3+7 Mn4+3 Mn2+1 O2-18 F-6 with properties {‘energy’: -452.20166} to supercell_structure. Throwing out.n”,
” Error Message: Mapping could not be found from structure.n”,
“Unable to match Li+6 Mn3+6 Mn4+3 O2-18 with properties {‘energy’: -363.96163} to supercell_structure. Throwing out.n”,
” Error Message: Mapping could not be found from structure.n”,
“Unable to match Li+9 Mn3+5 Mn4+2 O2-16 with properties {‘energy’: -321.98387} to supercell_structure. Throwing out.n”,
” Error Message: Mapping could not be found from structure.n”,
“Unable to match Li+9 Mn3+5 Mn4+2 O2-16 with properties {‘energy’: -321.62407} to supercell_structure. Throwing out.n”,
” Error Message: Mapping could not be found from structure.n”,
“Serial finished in 70.37592911720276 seconds.n”,
“Matched 17/26n”</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>],
“source”: [</p>
<blockquote>
<div><p>“wrangler.remove_all_data()n”,
“n”,
“start = time()n”,
“n”,
“for s, e in lmof_data:n”,
”    wrangler.add_data(s, {‘energy’: e}, verbose=True)n”,
“n”,
“print(f’Serial finished in {time()-start} seconds.’)n”,
“print(f’Matched {wrangler.num_structures}/{len(lmof_data)} structures.’)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: []</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>],
“metadata”: {</p>
<blockquote>
<div><dl class="simple">
<dt>“kernelspec”: {</dt><dd><p>“display_name”: “matx_dev”,
“language”: “python”,
“name”: “matx_dev”</p>
</dd>
</dl>
<p>},
“language_info”: {</p>
<blockquote>
<div><dl class="simple">
<dt>“codemirror_mode”: {</dt><dd><p>“name”: “ipython”,
“version”: 3</p>
</dd>
</dl>
<p>},
“file_extension”: “.py”,
“mimetype”: “text/x-python”,
“name”: “python”,
“nbconvert_exporter”: “python”,
“pygments_lexer”: “ipython3”,
“version”: “3.8.5”</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>},
“nbformat”: 4,
“nbformat_minor”: 4</p>
</dd>
</dl>
<p>}</p>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2020, Ceder Group.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.1.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>