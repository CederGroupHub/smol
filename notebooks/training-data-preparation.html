
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>&lt;no title&gt; &#8212; smol 0.0.1 documentation</title>
    
    <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
  
    
    <link rel="stylesheet"
      href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">
  
    
      
  
    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/pydata-sphinx-theme.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/smol.css" />
    
    <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/logo.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../getting_started.html">
  Getting Started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../user_guide/index.html">
  User Guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api_reference/index.html">
  API Reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../citing.html">
  Citing
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../developer_guide/index.html">
  Developing
 </a>
</li>

    
    <li class="nav-item">
        <a class="nav-link nav-external" href="https://github.com/CederGroupHub/smol/blob/master/CHANGES.md">Changes<i class="fas fa-external-link-alt"></i></a>
    </li>
    
    <li class="nav-item">
        <a class="nav-link nav-external" href="https://github.com/CederGroupHub/smol/issues">Issues<i class="fas fa-external-link-alt"></i></a>
    </li>
    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-primary btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        0.0.1  <!-- this text may get changed later by javascript -->
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
</div>

<!-- NOTE: this JS must live here (not in our global JS file) because it relies
     on being processed by Jinja before it is run (specifically for replacing
     variables notebooks/training-data-preparation and {'json_url': 'https://pydata-sphinx-theme.readthedocs.io/en/latest/_static/switcher.json', 'url_template': 'https://pydata-sphinx-theme.readthedocs.io/en/v{version}/', 'version_match': '0.0.1'}.
-->

<script type="text/javascript">
// Construct the target URL from the JSON components
function buildURL(entry) {
    var template = "https://pydata-sphinx-theme.readthedocs.io/en/v{version}/";  // supplied by jinja
    template = template.replace("{version}", entry.version);
    return template;
}

// Check if corresponding page path exists in other version of docs
// and, if so, go there instead of the homepage of the other docs version
function checkPageExistsAndRedirect(event) {
    const currentFilePath = "notebooks/training-data-preparation.html",
          tryUrl = event.target.getAttribute("href");
    let otherDocsHomepage = tryUrl.replace(currentFilePath, "");
    $.ajax({
        type: 'HEAD',
        url: tryUrl,
        // if the page exists, go there
        success: function() {
            location.href = tryUrl;
        }
    }).fail(function() {
        location.href = otherDocsHomepage;
    });
    // this prevents the browser from following the href of the clicked node
    // (which is fine because this function takes care of redirecting)
    return false;
}

// Populate the version switcher from the JSON config file
(function () {
    $.getJSON("https://pydata-sphinx-theme.readthedocs.io/en/latest/_static/switcher.json", function(data, textStatus, jqXHR) {
        const currentFilePath = "notebooks/training-data-preparation.html";
        // create links to the corresponding page in the other docs versions
        $.each(data, function(index, entry) {
            // if no custom name specified (e.g., "latest"), use version string
            if (!("name" in entry)) {
                entry.name = entry.version;
            }
            // create the node
            const node = document.createElement("a");
            node.setAttribute("class", "list-group-item list-group-item-action py-1");
            node.textContent = `${entry.name}`;
            // get the base URL for that doc version, add the current page's
            // path to it, and set as `href`
            entry.url = buildURL(entry);
            node.setAttribute("href", `${entry.url}${currentFilePath}`);
            // on click, AJAX calls will check if the linked page exists before
            // trying to redirect, and if not, will redirect to the homepage
            // for that version of the docs.
            node.onclick = checkPageExistsAndRedirect;
            $("#version_switcher_menu").append(node);
            // replace dropdown button text with the preferred display name of
            // this version, rather than using sphinx's 0.0.1 variable.
            // also highlight the dropdown entry for the currently-viewed
            // version's entry
            if (entry.version == "0.0.1") {
                node.classList.add("active");
                $("#version_switcher_button").text(entry.name);
            }
        });
    });
})();
</script>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/CederGroupHub/smol" rel="noopener" target="_blank" title="GitHub"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="simple visible nav section-nav flex-column">
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                

<div class="tocsection editthispage">
    <a href="https://github.com/CederGroupHub/smol/edit/master/docs/notebooks/training-data-preparation.ipynb">
        <i class="fas fa-pencil-alt"></i> Edit this page
    </a>
</div>

              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <dl>
<dt>{</dt><dd><dl>
<dt>“cells”: [</dt><dd><dl>
<dt>{</dt><dd><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“# Training Data Preparation”</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“import numpy as npn”,
“import jsonn”,
“from monty.serialization import loadfnn”,
“from pymatgen.core.structure import Structuren”,
“from smol.cofe import ClusterSubspace, StructureWranglern”,
“from smol.cofe.space import get_species”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“### 1) Preparing a <cite>StructureWrangler</cite>n”,
“Training structures and target data are handled by the <cite>StructureWrangler</cite> class. The class obtains the features and corresponding feature matrix based on the underlying <cite>ClusterSubspace</cite> provided.n”,
“n”,
“In the most simply settings we just use the feature matrix our supplied total energy from DFT to fit a cluster expansion. But it many cases we may want to improve our fit quality or reduce the model complexity by modifying the target property (i.e. using a reference energy or the energy of mixing) and/or by weighing structures based on some importance metric (i.e. by energy above hull). Using the <cite>StructureWrangler</cite> we can create this modified fitting data.”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“# Load the raw datan”,
“# load the prim structuren”,
“lno_prim = loadfn(‘data/lno_prim.json’)n”,
”    n”,
“# load the fitting datan”,
“# load the fitting datan”,
“lno_entries = loadfn(&quot;data/lno_entries.json&quot;)n”,
”  n”,
“# create a cluster subspacen”,
“subspace = ClusterSubspace.from_cutoffs(lno_prim,n”,
”                                        cutoffs={2: 5, 3: 4.1},n”,
”                                        basis=’sinusoid’,n”,
”                                        supercell_size=’O2-‘)n”,
“n”,
“# create the structre wranglern”,
“wrangler = StructureWrangler(subspace)n”,
“n”,
“# add the raw datan”,
“for entry in lno_entries:n”,
”    wrangler.add_entry(entry, verbose=False)n”,
“n”,
“print(f’\nTotal structures that match {wrangler.num_structures}/{len(lno_entries)}’)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“### 2) Modifying and adding new target propertiesn”,
“n”,
“Now that we have access to the structures that match to our cluster subspace, and access to the raw and normalized target properties, we can easily create new modifiend target properties to fit to.n”,
“n”,
“For a simple example say we simply want to set the minimum energy in our data as a new reference point.”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“# obtain the minimum energy. Calling the get_property_vectorn”,
“# will by default give you the property normalized per prim n”,
“# (you should always used consistently normalized data when fitting)n”,
“min_energy = min(wrangler.get_property_vector(‘energy’))n”,
“n”,
“# simply create a new re-reference energyn”,
“reref_energy_vect = wrangler.get_property_vector(‘energy’) - min_energyn”,
“n”,
“# add it as a new property to the wranglern”,
“# in this case since the reref energy is a normalizedn”,
“# quantity we need to explicitly tell the wranglern”,
“wrangler.add_properties(‘rereferenced_energy’, reref_energy_vect)n”,
“n”,
“# Now we have to properties in the wrangler that we cann”,
“# use to fit a cluster expansion, the total energyn”,
“# and the rereference energyn”,
“print(wrangler.available_properties)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“### 2.1) Another example of modifying target propertiesn”,
“n”,
“We can do more complex modifications of the target data. For example a very common target property to fit a cluster expansion is the mixing energy. n”,
“n”,
“For the current LNO dataset we don’t have a fully delithiated structure, but for the sake of illustration lets assume that we use Ni2O3. (Plus in this dataset mixing energy is not very informative since it is almost linear in concentration.)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“e_Ni2O3 = -12.48n”,
“n”,
“# we can obtain the fully lithiated structure in the dataset by searchingn”,
“# through the occupancy strings.n”,
“ind = [i for i, s in enumerate(wrangler.occupancy_strings) if ‘Vacancy’ not in s]n”,
“e_LiNiO2 = wrangler.get_property_vector(‘energy’)[ind[0]]n”,
“n”,
“# Now we can calculate the Li/Vacancy mixing energy for the structures in our datasetn”,
“# There are many ways you can obtain concentrations/compositions, here I use the n”,
“# occupancy strings stored in the wrangler.n”,
“# If the proper end points are calculated we can also use pymatgens PhaseDiagramn”,
“# with the entries in the wrangler, and obtain the mixing energy with much less effort!n”,
“mixing_energy = []n”,
“concentration = []n”,
“for size, energy, occu in zip(wrangler.sizes,n”,
”                              wrangler.get_property_vector(‘energy’),n”,
”                              wrangler.occupancy_strings):n”,
”    n_Li = sum(sp == get_species(‘Li+’) for sp in occu)n”,
”    n_vac = sum(sp == get_species(‘Vacancy’) for sp in occu)n”,
”    c_Li = n_Li/(n_Li + n_vac)n”,
”    mix_en = energy - c_Li*e_LiNiO2 - (1 - c_Li)*e_Ni2O3n”,
”    concentration.append(c_Li)n”,
”    # remember to use the &quot;extensive&quot; (per supercell) valuen”,
”    mixing_energy.append(size * mix_en)n”,
“n”,
“# add the properties to the wranglern”,
“wrangler.add_properties(‘mixing_energy’, mixing_energy)n”,
“wrangler.add_properties(‘li_concentration’, concentration)n”,
“print(wrangler.available_properties)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“### 3) Obtaining and adding weightsn”,
“n”,
“Using the structure wrangler it is also very easy to obtain fitting weights based many things such as composition, total energy or energy above hull. Currently the code has the previously available functions to obtaine weights by energy above hull or by energy above composition.”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“from smol.cofe.wrangling import weights_energy_above_hull, weights_energy_above_compositionn”,
“n”,
“above_compostion = weights_energy_above_composition(n”,
”    wrangler.structures, wrangler.get_property_vector(‘energy’, normalize=False),n”,
”    temperature=1000)n”,
“n”,
“above_hull = weights_energy_above_hull(n”,
”    wrangler.structures, wrangler.get_property_vector(‘energy’, normalize=False),n”,
”    cs_structure=wrangler.cluster_subspace.structure,n”,
”    temperature=1000)n”,
“n”,
“# add them to the wranglern”,
“wrangler.add_weights(‘energy_above_comp’, above_compostion)n”,
“wrangler.add_weights(‘energy_above_hull’, above_hull)n”,
“n”,
“# to use weights in a fit you would simply pass them ton”,
“# the corresponding argument or keyword argument ofn”,
“# the fitting function you are using.n”,
“# For example if you are using a regression class fromn”,
“# scikit-learn,n”,
“from sklearn.linear_model import LinearRegressionn”,
“estimator = LinearRegression(fit_intercept=False)n”,
“estimator.fit(wrangler.feature_matrix,n”,
”              wrangler.get_property_vector(‘energy’),n”,
”              sample_weight=wrangler.get_weights(‘energy_above_hull’))”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“### 4) Structure Selectionn”,
“The <cite>StructureWrangler</cite> class can also be used to ‘filter’ structures to use for a fit based on some criteria. To do so we obtain the indices of all structures that satisfy some filtering criteran”,
“n”,
“For example here we will obtain all the structures with electrostatic energy below a given cuttoff”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“# filter by maximum ewald energyn”,
“# all structures with ewald energy above the cutoffn”,
“# will be removedn”,
“from smol.cofe.wrangling import max_ewald_energy_indicesn”,
“n”,
“# get the structure indicesn”,
“indices = max_ewald_energy_indices(wrangler, max_relative_energy=2)n”,
“# save them in the structure wranglern”,
“wrangler.add_data_indices(‘low_electrostat_energy’, indices)n”,
“n”,
“print(f’Included {len(indices)}/{wrangler.num_structures} structures with Ewald energies &lt; 2 eV/prim.’)n”,
“print(f’Saved indices are {wrangler.available_indices}’)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“# you can use the indices for selected structures ton”,
“# obtain only the corresponding values for those structuresn”,
“feature_matrix = wrangler.feature_matrix[indices]n”,
“prop_vector = wrangler.get_property_vector(‘energy’)[indices]n”,
“n”,
“print(f’Feature matrix shape: {feature_matrix.shape}’)n”,
“print(f’Property vector shape {prop_vector.shape}’)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>],
“metadata”: {</p>
<blockquote>
<div><dl class="simple">
<dt>“kernelspec”: {</dt><dd><p>“display_name”: “matx_dev”,
“language”: “python”,
“name”: “matx_dev”</p>
</dd>
</dl>
<p>},
“language_info”: {</p>
<blockquote>
<div><dl class="simple">
<dt>“codemirror_mode”: {</dt><dd><p>“name”: “ipython”,
“version”: 3</p>
</dd>
</dl>
<p>},
“file_extension”: “.py”,
“mimetype”: “text/x-python”,
“name”: “python”,
“nbconvert_exporter”: “python”,
“pygments_lexer”: “ipython3”,
“version”: “3.9.5”</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>},
“nbformat”: 4,
“nbformat_minor”: 4</p>
</dd>
</dl>
<p>}</p>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              
          </main>
          

      </div>
    </div>
  
    <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
  <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022-2022, Ceder Group.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.1.2.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>